library(data.table)

transform.chi <- function(perm, truth)
{
    for(i in 1:nrow(perm))
    {
        perm[i,] = multipleTesting$median.correct.2(perm[i,])
    }
    truth = multipleTesting$median.correct.2(truth)
    return(list(perm=perm, truth = truth))
}

transform.norm <- function(perm,truth)
{
    for(i in 1:nrow(perm))
    {
        perm[i,] = multipleTesting$median.correct(perm[i,])
    }
    truth = multipleTesting$median.correct(truth)
    return(list(perm=perm, truth = truth))
}

transform.ident <- function(perm, truth)
{
    return(list(perm=perm, truth = truth))
}


perv = out$results$results$per.variable
perms = out$perm


nms = c("Strain", "Diet", "Diet:Strain")
permz = list()
for(i in 1:length(nms))
{
    permz[[nms[i]]]= perms[[i]]
}
perms = permz

f = transform.ident ##transform.chi ##transform.ident ##transform.chi ##transform.norm ##transform.chi


#nms = c("Strain", "Diet", "Diet:Strain")
nms = "Diet"
lrrc16a = "10408280"
Mir341  = "10398350"
Meg3    = "10398326"
Cnot2   = inp$probesetInfo[gene_name=="Cnot2"]$Probe.Set.ID
for(i in 1:length(nms))
{
    nm = nms[[i]]
    print(nm)
    perm = perms[[nm]]
    
    
    
    ident = perv[variable==nm]

    setkey(ident, "Probe.Set.ID")
    truth = ident[colnames(perm)]$anova.p.value

    ## x = apply(inp$exp.mat, 2, mean)
    ## z = x[x>7]
    
    perm = perm[,names(z)]
    truth = truth[names(z)]
    pt = f(perm, truth)
    perm = pt$perm
    truth = pt$truth
    
    
    names(truth) = colnames(perm)
    local.empirical = rep(NA, length(truth))
    names(local.empirical)  = colnames(perm)
    for(j in 1:ncol(perm))
    {
        local.empirical[j] = sum(truth[j]>perm[,j], na.rm = T)/nrow(perm)
    }

    fd = p.adjust(local.empirical, method="fdr")
    goodp = names(fd)[fd<=.05]
    goodg = inp$probesetInfo[Probe.Set.ID %in% goodp]$gene_name
    numfdr = length(goodg)
    
    ## goodp = colnames(perm)[head(order(local.empirical), 30)]
    ## goodg = inp$probesetInfo[Probe.Set.ID %in% goodp]$gene_name

    pmindist = apply(perm, 1, min, na.rm=T)
    fwer = quantile(pmindist, .05)
    numfwer = sum(truth<fwer)
    print(numfdr)
    print(numfwer)

    minz = apply(perm, 2, min)
    bads = truth[head(order(minz), 10000)]

    ind = 5800
    cov.data = inp$cov.data.full
    cov.data$ID = gsub(cov.data$ID, pattern = "Mouse\\.", replacement = "")
    df = data.frame(mic = inp$exp.mat[,names(bads[ind])],
                    nm  =  gsub(rownames(inp$exp.mat), pattern = "Mouse\\.", replacement=""))
    df = data.table(df)
    df = df[cov.data, on=c(nm="ID")]
    aplot = ggplot(df)
    aplot = aplot + geom_text(aes(x=as.integer(Diet), y=mic, label = nm, color=Strain))
    print(aplot)          
                    
    
    browser()
}

    
